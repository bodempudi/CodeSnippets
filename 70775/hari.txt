Derived Sales = 
VAR _Target = SELECTEDVALUE(Targetsales[Targetsales], 0)
VAR _Yr     = MAX(SalesByMonth[year])

-- Year-level aggregates
VAR _ActualYear =
    CALCULATE(
        SUM(SalesByMonth[sales]),
        FILTER(ALL(SalesByMonth), SalesByMonth[year] = _Yr)
    )
VAR _WD_Zero_Total =
    CALCULATE(
        SUM(SalesByMonth[numberofworkingdays]),
        FILTER(
            ALL(SalesByMonth),
            SalesByMonth[year] = _Yr &&
            COALESCE(SalesByMonth[sales], 0) = 0
        )
    )
VAR _Leftover = _Target - _ActualYear

-- Row value (safe for month rows)
VAR _SalesThisMonth = SUM(SalesByMonth[sales])
VAR _WD_ThisMonth   = MAX(SalesByMonth[numberofworkingdays])
VAR _RowValue =
    IF(
        _SalesThisMonth > 0,
        _SalesThisMonth,
        DIVIDE(_Leftover * _WD_ThisMonth, _WD_Zero_Total, 0)
    )

-- Month table with context transition (for totals)
VAR _MonthTable =
    ADDCOLUMNS(
        VALUES(SalesByMonth[monthnumber]),
        "Sales", CALCULATE(SUM(SalesByMonth[sales])),              -- CTX transition
        "WD",    CALCULATE(MAX(SalesByMonth[numberofworkingdays])) -- CTX transition
    )
RETURN
IF(
    HASONEVALUE(SalesByMonth[monthnumber]),
    _RowValue,
    SUMX(
        _MonthTable,
        IF([Sales] > 0, [Sales], DIVIDE(_Leftover * [WD], _WD_Zero_Total, 0))
    )
)
